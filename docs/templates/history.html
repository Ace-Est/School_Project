<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>歷史查詢 - 智慧能源監控平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container { min-height: 400px; }
        .nav-link.active { background-color: #007bff !important; color: white !important; }
    </style>
</head>
<body>
<div class="container py-4">
    <h1 class="mb-4">智慧能源監控平台</h1>
    
    <!-- 導航欄 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
        <div class="container-fluid">
            <span class="navbar-brand">功能選單</span>
            <div class="navbar-nav">
                <a class="nav-link" href="/prediction">用電預測</a>
                <a class="nav-link active" href="/history">歷史查詢</a>
                <a class="nav-link" href="/battery">蓄電池管理</a>
                <a class="nav-link" href="/upload">資料上傳預測</a>
            </div>
        </div>
    </nav>

    <div class="alert alert-info">
        <ul>
            <li>本系統預測三條線：<b style='color:red'>耗電量 (use)</b>、<b style='color:green'>發電量 (pv)</b>、<b style='color:orange'>淨負載 (kpt = use - pv)</b>。</li>
            <li>發電量 (pv) 僅用天氣與小時預測，夜間自動為 0。</li>
            <li>所有預測均經過對應 AI 模型 (xgb_use.json, xgb_pv.json)。</li>
            <li><b style='color:blue'>契約容量限制：785 kWh/小時</b> - 每小時從電網購電量不能超過此限制。</li>
        </ul>
    </div>

    <!-- 查詢控制 -->
    <div class="mb-3">
        <label for="history-date-picker" class="form-label">選擇日期：</label>
        <input type="date" id="history-date-picker" class="form-control" style="max-width:200px;display:inline-block;">
        <button class="btn btn-primary ms-2" id="history-query-btn">查詢</button>
    </div>

    <!-- 契約容量監控 -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>契約容量監控</h5>
                </div>
                <div class="card-body">
                    <div id="history-contract-monitor">
                        <p class="text-muted">請選擇日期進行查詢</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 圖表區域 -->
    <div class="chart-container">
        <canvas id="historyKptChart"></canvas>
    </div>

    <!-- 計費摘要 -->
    <div id="bill-summary" class="mt-4">
        <h5>用電計費（分時段）</h5>
        <table class="table table-bordered w-auto">
            <thead>
                <tr>
                    <th>時段</th>
                    <th>用電度數 (kWh)</th>
                    <th>電費金額 (元)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>尖峰</td>
                    <td id="peak-kwh">-</td>
                    <td id="peak-fee">-</td>
                </tr>
                <tr>
                    <td>半尖峰</td>
                    <td id="halfpeak-kwh">-</td>
                    <td id="halfpeak-fee">-</td>
                </tr>
                <tr>
                    <td>離峰</td>
                    <td id="offpeak-kwh">-</td>
                    <td id="offpeak-fee">-</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// 全域變數
let historyKptChart = null;

// 動態調整 Y 軸範圍的函數
function getAdjustedYAxis(dataArrays) {
    const allData = dataArrays.flat();
    const minVal = Math.min(...allData);
    const maxVal = Math.max(...allData);
    
    // 預設範圍
    let yMin = -100;
    let yMax = 800;
    
    // 如果數據超出範圍，則調整
    if (minVal < -100) {
        yMin = Math.floor(minVal / 100) * 100 - 100;
    }
    if (maxVal > 800) {
        yMax = Math.ceil(maxVal / 100) * 100 + 100;
    }
    
    return { min: yMin, max: yMax };
}

// 契約容量監控顯示函數
function displayContractMonitor(contractCheck, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    if (!contractCheck) {
        container.innerHTML = '<p class="text-muted">無契約容量資料</p>';
        return;
    }
    
    const { contract_capacity, total_power_usage, violations, max_power, min_power, avg_power } = contractCheck;
    
    let html = `
        <div class="row">
            <div class="col-md-3">
                <div class="card ${max_power > contract_capacity ? 'border-danger' : 'border-success'}">
                    <div class="card-body text-center">
                        <h6>契約容量</h6>
                        <h4 class="text-primary">${contract_capacity} kWh</h4>
                        <small class="text-muted">每小時限制</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card ${max_power > contract_capacity ? 'border-danger' : 'border-success'}">
                    <div class="card-body text-center">
                        <h6>最大用電</h6>
                        <h4 class="${max_power > contract_capacity ? 'text-danger' : 'text-success'}">${max_power.toFixed(1)} kWh</h4>
                        <small class="text-muted">${max_power > contract_capacity ? '⚠️ 超過限制' : '✅ 符合限制'}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h6>平均用電</h6>
                        <h4 class="text-info">${avg_power.toFixed(1)} kWh</h4>
                        <small class="text-muted">24小時平均</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h6>最小用電</h6>
                        <h4 class="text-warning">${min_power.toFixed(1)} kWh</h4>
                        <small class="text-muted">24小時最低</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (violations.length > 0) {
        html += `
            <div class="alert alert-danger mt-3">
                <h6>⚠️ 契約容量違規警告</h6>
                <p>發現 ${violations.length} 個小時超過契約容量限制：</p>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>小時</th>
                                <th>總用電量 (kWh)</th>
                                <th>超出量 (kWh)</th>
                                <th>kpt (kWh)</th>
                                <th>充電量 (kWh)</th>
                                <th>放電量 (kWh)</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        violations.forEach(violation => {
            html += `
                <tr>
                    <td>${violation.hour}時</td>
                    <td><strong class="text-danger">${violation.total_power.toFixed(1)}</strong></td>
                    <td><strong class="text-danger">+${violation.excess.toFixed(1)}</strong></td>
                    <td>${violation.kpt.toFixed(1)}</td>
                    <td>${violation.charge.toFixed(1)}</td>
                    <td>${violation.discharge.toFixed(1)}</td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="alert alert-success mt-3">
                <h6>✅ 契約容量符合</h6>
                <p>所有小時的用電量都在契約容量限制內，最大用電量為 ${max_power.toFixed(1)} kWh。</p>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// 歷史查詢圖表
function renderHistoryKptChart(hours, actual_use, actual_kpt, actual_pv, use_pred, kpt_pred, pv_pred) {
    if (historyKptChart) historyKptChart.destroy();
    const ctx = document.getElementById('historyKptChart').getContext('2d');
    
    // 動態調整 Y 軸範圍
    const yAxis = getAdjustedYAxis([actual_use, actual_kpt, actual_pv, use_pred, kpt_pred, pv_pred]);
    
    // 契約容量參考線
    const contractCapacity = 785;
    const contractLine = new Array(hours.length).fill(contractCapacity);
    
    historyKptChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: hours,
            datasets: [
                {
                    label: '實際耗電量 (use)',
                    data: actual_use,
                    borderColor: 'red',
                    borderDash: [5, 5],
                    fill: false
                },
                {
                    label: '實際發電量 (pv)',
                    data: actual_pv,
                    borderColor: 'green',
                    borderDash: [5, 5],
                    fill: false
                },
                {
                    label: '實際 kpt',
                    data: actual_kpt,
                    borderColor: 'orange',
                    borderDash: [5, 5],
                    fill: false
                },
                {
                    label: '預測耗電量 (use)',
                    data: use_pred,
                    borderColor: 'red',
                    fill: false
                },
                {
                    label: '預測發電量 (pv)',
                    data: pv_pred,
                    borderColor: 'green',
                    fill: false
                },
                {
                    label: '預測 kpt',
                    data: kpt_pred,
                    borderColor: 'orange',
                    fill: false
                },
                {
                    label: '契約容量限制',
                    data: contractLine,
                    borderColor: 'blue',
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: {
                x: { title: { display: true, text: 'Hour' } },
                y: {
                    title: { display: true, text: 'kWh' },
                    min: yAxis.min,
                    max: yAxis.max,
                    ticks: { stepSize: 100 }
                }
            }
        }
    });
}

// 分時段計費計算
function renderBillSummary(hours, actual, dateStr) {
    // 尖峰、半尖峰、離峰時段定義與電價
    function isSummer(date) {
        const m = date.getMonth() + 1;
        const d = date.getDate();
        if (m > 5 && m < 10) return true;
        if (m === 5 && d >= 16) return true;
        if (m === 10 && d <= 15) return true;
        return false;
    }
    function getTimeType(date, hour) {
        const wd = date.getDay(); // 0=Sun, 6=Sat
        const summer = isSummer(date);
        if (wd >= 1 && wd <= 5) { // 平日
            if (summer) {
                if (hour >= 16 && hour < 22) return ['peak', 5.8];
                if ((hour >= 9 && hour < 16) || (hour >= 22 && hour < 24)) return ['half_peak', 3.63];
                return ['off_peak', 1.58];
            } else {
                if ((hour >= 6 && hour < 11) || (hour >= 14 && hour < 24)) return ['half_peak', 3.4];
                return ['off_peak', 1.45];
            }
        } else if (wd === 6) { // 週六
            if (summer) {
                if (hour >= 9 && hour < 24) return ['half_peak', 1.78];
                return ['off_peak', 1.58];
            } else {
                if ((hour >= 6 && hour < 11) || (hour >= 14 && hour < 24)) return ['half_peak', 1.65];
                return ['off_peak', 1.45];
            }
        } else { // 週日
            if (summer) return ['off_peak', 1.58];
            return ['off_peak', 1.45];
        }
    }
    let peakKwh = 0, halfPeakKwh = 0, offPeakKwh = 0;
    let peakFee = 0, halfPeakFee = 0, offPeakFee = 0;
    for (let i = 0; i < hours.length; i++) {
        const hour = hours[i];
        const kwh = actual[i];
        const date = new Date(dateStr);
        date.setHours(hour);
        const [ttype, rate] = getTimeType(date, hour);
        if (ttype === 'peak') {
            peakKwh += kwh;
            peakFee += kwh * rate;
        } else if (ttype === 'half_peak') {
            halfPeakKwh += kwh;
            halfPeakFee += kwh * rate;
        } else {
            offPeakKwh += kwh;
            offPeakFee += kwh * rate;
        }
    }
    document.getElementById('peak-kwh').innerText = peakKwh.toFixed(2);
    document.getElementById('peak-fee').innerText = peakFee.toFixed(2);
    document.getElementById('halfpeak-kwh').innerText = halfPeakKwh.toFixed(2);
    document.getElementById('halfpeak-fee').innerText = halfPeakFee.toFixed(2);
    document.getElementById('offpeak-kwh').innerText = offPeakKwh.toFixed(2);
    document.getElementById('offpeak-fee').innerText = offPeakFee.toFixed(2);
}

// 清除計費摘要
function clearHistoryBillSummary() {
    document.getElementById('peak-kwh').innerText = '--';
    document.getElementById('peak-fee').innerText = '--';
    document.getElementById('halfpeak-kwh').innerText = '--';
    document.getElementById('halfpeak-fee').innerText = '--';
    document.getElementById('offpeak-kwh').innerText = '--';
    document.getElementById('offpeak-fee').innerText = '--';
}

// 歷史查詢分頁查詢
function loadHistoryDates() {
    fetch('/dates')
        .then(res => res.json())
        .then(data => {
            const picker = document.getElementById('history-date-picker');
            if (data.length === 0) {
                picker.disabled = true;
                return;
            }
            picker.disabled = false;
            picker.min = data[0];
            picker.max = data[data.length-1];
            picker.value = data[data.length-1];
        });
}

// 歷史查詢按鈕事件
document.getElementById('history-query-btn').onclick = function() {
    const date = document.getElementById('history-date-picker').value;
    fetch(`/predict?date=${date}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            renderHistoryKptChart(
                data.hours,
                data.actual_use,
                data.actual_kpt,
                data.actual_pv,
                data.use_pred,
                data.kpt_pred,
                data.pv_pred
            );
            renderBillSummary(data.hours, data.actual_kpt, date);
            // 顯示契約容量監控
            if (data.contract_check) {
                displayContractMonitor(data.contract_check, 'history-contract-monitor');
            }
        });
};

// 頁面載入時初始化
document.addEventListener('DOMContentLoaded', function() {
    loadHistoryDates();
    clearHistoryBillSummary();
});
</script>
</body>
</html> 