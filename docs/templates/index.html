<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>æ™ºæ…§èƒ½æºç›£æ§å¹³å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .tab-content { margin-top: 30px; }
        .chart-container { min-height: 400px; }
        .upload-area { 
            border: 2px dashed #ccc; 
            border-radius: 8px; 
            padding: 40px; 
            text-align: center; 
            margin: 20px 0;
            transition: border-color 0.3s;
        }
        .upload-area:hover { border-color: #007bff; }
        .upload-area.dragover { border-color: #007bff; background-color: #f8f9fa; }
        .results-table { margin-top: 20px; }
        .download-btn { margin-top: 10px; }
    </style>
</head>
<body>
<div class="container py-4">
    <h1 class="mb-4">æ™ºæ…§èƒ½æºç›£æ§å¹³å°</h1>
    <div class="alert alert-info">
        <ul>
            <li>æœ¬ç³»çµ±é æ¸¬ä¸‰æ¢ç·šï¼š<b style='color:red'>è€—é›»é‡ (use)</b>ã€<b style='color:green'>ç™¼é›»é‡ (pv)</b>ã€<b style='color:orange'>æ·¨è² è¼‰ (kpt = use - pv)</b>ã€‚</li>
            <li>ç™¼é›»é‡ (pv) åƒ…ç”¨å¤©æ°£èˆ‡å°æ™‚é æ¸¬ï¼Œå¤œé–“è‡ªå‹•ç‚º 0ã€‚</li>
            <li>ä¸Šå‚³è³‡æ–™åªéœ€å¤©æ°£ã€æ™‚é–“ç­‰ç‰¹å¾µï¼Œä¸éœ€æœ‰ kptã€pvã€use æ¬„ä½ã€‚</li>
            <li>æ‰€æœ‰é æ¸¬å‡ç¶“éå°æ‡‰ AI æ¨¡å‹ (xgb_use.json, xgb_pv.json)ã€‚</li>
            <li><b style='color:blue'>å¥‘ç´„å®¹é‡é™åˆ¶ï¼š785 kWh/å°æ™‚</b> - æ¯å°æ™‚å¾é›»ç¶²è³¼é›»é‡ä¸èƒ½è¶…éæ­¤é™åˆ¶ã€‚</li>
        </ul>
    </div>
    <ul class="nav nav-tabs" id="mainTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="kpt-tab" data-bs-toggle="tab" data-bs-target="#kpt" type="button" role="tab">ç”¨é›»é æ¸¬</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">æ­·å²æŸ¥è©¢</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="battery-tab" data-bs-toggle="tab" data-bs-target="#battery" type="button" role="tab">è“„é›»æ± ç®¡ç†</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">è³‡æ–™ä¸Šå‚³é æ¸¬</button>
        </li>
    </ul>
    <div class="tab-content" id="mainTabContent">
        <div class="tab-pane fade show active" id="kpt" role="tabpanel">
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>å¥‘ç´„å®¹é‡ç›£æ§</h5>
                        </div>
                        <div class="card-body">
                            <div id="contract-monitor">
                                <p class="text-muted">è¼‰å…¥ä¸­...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="latestKptChart"></canvas>
            </div>
        </div>
        <div class="tab-pane fade" id="history" role="tabpanel">
            <div class="mb-3">
                <label for="history-date-picker" class="form-label">é¸æ“‡æ—¥æœŸï¼š</label>
                <input type="date" id="history-date-picker" class="form-control" style="max-width:200px;display:inline-block;">
                <button class="btn btn-primary ms-2" id="history-query-btn">æŸ¥è©¢</button>
            </div>
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>å¥‘ç´„å®¹é‡ç›£æ§</h5>
                        </div>
                        <div class="card-body">
                            <div id="history-contract-monitor">
                                <p class="text-muted">è«‹é¸æ“‡æ—¥æœŸé€²è¡ŒæŸ¥è©¢</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="historyKptChart"></canvas>
            </div>
            <div id="bill-summary" class="mt-4">
                <h5>ç”¨é›»è¨ˆè²»ï¼ˆåˆ†æ™‚æ®µï¼‰</h5>
                <table class="table table-bordered w-auto">
                    <thead>
                        <tr>
                            <th>æ™‚æ®µ</th>
                            <th>ç”¨é›»åº¦æ•¸ (kWh)</th>
                            <th>é›»è²»é‡‘é¡ (å…ƒ)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>å°–å³°</td>
                            <td id="peak-kwh">-</td>
                            <td id="peak-fee">-</td>
                        </tr>
                        <tr>
                            <td>åŠå°–å³°</td>
                            <td id="halfpeak-kwh">-</td>
                            <td id="halfpeak-fee">-</td>
                        </tr>
                        <tr>
                            <td>é›¢å³°</td>
                            <td id="offpeak-kwh">-</td>
                            <td id="offpeak-fee">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="tab-pane fade" id="battery" role="tabpanel">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>è“„é›»æ± ç‹€æ…‹</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">ç•¶å‰é›»é‡ï¼š</label>
                                <div class="progress mb-2">
                                    <div id="battery-level" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                                </div>
                                <small class="text-muted">
                                    <span id="battery-current">0</span> / 1260 kWh
                                </small>
                            </div>
                            <div class="mb-3">
                                <label for="battery-start-date" class="form-label">é–‹å§‹æ—¥æœŸï¼š</label>
                                <input type="date" id="battery-start-date" class="form-control" style="max-width:200px;display:inline-block;">
                            </div>
                            <div class="mb-3">
                                <label for="battery-end-date" class="form-label">çµæŸæ—¥æœŸï¼š</label>
                                <input type="date" id="battery-end-date" class="form-control" style="max-width:200px;display:inline-block;">
                                <button class="btn btn-primary ms-2" id="battery-query-btn">åˆ†ææ™‚é–“å€é–“</button>
                            </div>

                            <div class="mb-3">
                                <div class="alert" style="background-color: #d1ecf1; border-color: #bee5eb;">
                                    <strong class="text-dark">åˆå§‹é›»é‡ï¼š</strong> <span class="text-dark">0åº¦ï¼ˆç³»çµ±è‡ªå‹•è¨­å®šï¼‰</span>
                                </div>
                            </div>
                            <div class="alert" style="background-color: #d1ecf1; border-color: #bee5eb;">
                                <h6 class="text-dark">è“„é›»æ± è¦æ ¼ï¼š</h6>
                                <ul class="mb-0 text-dark">
                                    <li>ç¸½å®¹é‡ï¼š1260 kWh</li>
                                    <li>å®‰å…¨ç¯„åœï¼š126 - 1134 kWh (10% - 90%)</li>
                                    <li>æœ€å¤§å……é›»åŠŸç‡ï¼š200 kWh/å°æ™‚</li>
                                    <li>æœ€å¤§æ”¾é›»åŠŸç‡ï¼š200 kWh/å°æ™‚</li>
                                    <li>å……é›»æ•ˆç‡ï¼š100%ï¼ˆå……é›»ç„¡æè€—ï¼‰</li>
                                    <li>æ”¾é›»æ•ˆç‡ï¼š90%ï¼ˆ10%æ”¾é›»æè€—ï¼‰</li>
                                    <li>è‡ªæ”¾é›»æè€—ï¼š0.03%/å°æ™‚</li>
                                    <li><strong style='color:blue'>å¥‘ç´„å®¹é‡é™åˆ¶ï¼š785 kWh/å°æ™‚</strong></li>
                                    <li><strong style='color:red'>ç­–ç•¥ï¼šå„ªå…ˆé¿å…è¶…éå¥‘ç´„å®¹é‡</strong></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>çœéŒ¢æ–¹æ¡ˆåˆ†æ</h5>
                        </div>
                        <div class="card-body">
                            <div id="battery-analysis">
                                <p class="text-muted">è«‹é¸æ“‡æ—¥æœŸé€²è¡Œåˆ†æ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å¥‘ç´„å®¹é‡ç›£æ§ -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>å¥‘ç´„å®¹é‡ç›£æ§ï¼ˆè“„é›»æ± ç­–ç•¥å¾Œï¼‰</h5>
                        </div>
                        <div class="card-body">
                            <div id="battery-contract-monitor">
                                <p class="text-muted">è«‹é¸æ“‡æ—¥æœŸç¯„åœé€²è¡Œåˆ†æ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <!-- åœ–è¡¨å°èˆªæ§åˆ¶ -->
                    <div class="mb-3">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-secondary" id="prev-day-btn" disabled>å‰ä¸€å¤©</button>
                            <button class="btn btn-outline-secondary" id="next-day-btn" disabled>å¾Œä¸€å¤©</button>
                            <button class="btn btn-outline-primary" id="overview-btn" disabled>ç¸½é«”è¦–åœ–</button>
                        </div>
                        <span class="ms-3" id="current-day-display">è«‹å…ˆåˆ†ææ™‚é–“å€é–“</span>
                    </div>
                    <div class="chart-container" style="min-height: 400px;">
                        <canvas id="batteryChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>è©³ç´°åˆ†æçµæœ</h5>
                        </div>
                        <div class="card-body">
                            <div id="battery-details">
                                <p class="text-muted">è«‹é¸æ“‡æ—¥æœŸæŸ¥çœ‹è©³ç´°åˆ†æ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="upload" role="tabpanel">
            <div class="row">
                <div class="col-md-6">
                    <h5>ä¸Šå‚³è³‡æ–™æª”æ¡ˆ</h5>
                    <div class="upload-area" id="upload-area">
                        <div class="mb-3">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #ccc;"></i>
                        </div>
                        <p class="text-muted">æ‹–æ‹½ CSV æª”æ¡ˆåˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                        <input type="file" id="file-input" accept=".csv" style="display: none;">
                        <button class="btn btn-outline-primary" onclick="document.getElementById('file-input').click()">
                            é¸æ“‡æª”æ¡ˆ
                        </button>
                    </div>
                    <div class="mb-3">
                        <h6>æª”æ¡ˆæ ¼å¼è¦æ±‚ï¼š</h6>
                        <ul class="text-muted">
                            <li>CSV æ ¼å¼æª”æ¡ˆ</li>
                            <li>å¿…è¦æ¬„ä½ï¼šDate, Temperature, Humidity, Rain, Hour</li>
                            <li>å¯é¸æ¬„ä½ï¼šday_weekï¼ˆè‹¥ç„¡æœƒè‡ªå‹•è¨ˆç®—ï¼‰ã€kptï¼ˆåƒ…ä¾›å°ç…§ï¼Œä¸å½±éŸ¿é æ¸¬ï¼‰ã€labelï¼ˆè‹¥ç„¡å‰‡è‡ªå‹•è¨­é è¨­å€¼ï¼‰</li>
                            <li>ä¸éœ€ä¸Šå‚³ pv/use æ¬„ä½ï¼Œç³»çµ±æœƒè‡ªå‹•é æ¸¬</li>
                        </ul>
                    </div>
                    <div class="mb-3">
                        <button class="btn btn-primary" id="upload-btn" disabled>é–‹å§‹é æ¸¬</button>
                        <div id="upload-status" class="mt-2"></div>
                    </div>
                    
                    <!-- æ—¥æ›†é¸æ“‡å™¨ -->
                    <div class="mt-4">
                        <h6>é¸æ“‡æŸ¥çœ‹æ—¥æœŸ</h6>
                        <div class="row">
                            <div class="col-md-8">
                                <label for="upload-date-picker" class="form-label">æ—¥æœŸï¼š</label>
                                <input type="date" id="upload-date-picker" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-outline-primary d-block w-100" id="change-date-btn" disabled>åˆ‡æ›æ—¥æœŸ</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>é æ¸¬çµæœ</h5>
                    <div id="upload-results">
                        <p class="text-muted">è«‹å…ˆä¸Šå‚³æª”æ¡ˆé€²è¡Œé æ¸¬</p>
                    </div>
                </div>
            </div>
            
            <!-- å¥‘ç´„å®¹é‡ç›£æ§ -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>å¥‘ç´„å®¹é‡ç›£æ§</h5>
                        </div>
                        <div class="card-body">
                            <div id="upload-contract-monitor">
                                <p class="text-muted">è«‹å…ˆä¸Šå‚³æª”æ¡ˆé€²è¡Œé æ¸¬</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- åœ–è¡¨å€åŸŸ -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="chart-container">
                        <canvas id="uploadKptChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- é æ¸¬çµæœè¡¨æ ¼ -->
            <div class="row mt-3">
                <div class="col-12">
                    <div id="upload-results-table" class="results-table" style="display: none;">
                        <h6>é æ¸¬çµæœ</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>æ—¥æœŸ</th>
                                        <th>å°æ™‚</th>
                                        <th>é æ¸¬ use</th>
                                        <th>é æ¸¬ pv</th>
                                        <th>é æ¸¬ kpt</th>
                                    </tr>
                                </thead>
                                <tbody id="results-tbody">
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-success download-btn" id="download-csv-btn">ä¸‹è¼‰é æ¸¬çµæœ (CSV)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js"></script>
<script>
// å…¨åŸŸè®Šæ•¸
let latestKptChart = null;
let historyKptChart = null;
let uploadKptChart = null;
let batteryChart = null;
let uploadedFile = null;
let predictionResults = null;
let allPredictionResults = null; // ä¿å­˜æ‰€æœ‰ä¸Šå‚³çš„æ•¸æ“š
let dateRangeData = null; // ä¿å­˜æ—¥æœŸç¯„åœæ•¸æ“š
let currentDayIndex = 0; // ç•¶å‰é¡¯ç¤ºçš„æ—¥æœŸç´¢å¼•

// å‹•æ…‹èª¿æ•´ Y è»¸ç¯„åœçš„å‡½æ•¸
function getAdjustedYAxis(dataArrays) {
    const allData = dataArrays.flat();
    const minVal = Math.min(...allData);
    const maxVal = Math.max(...allData);
    
    // é è¨­ç¯„åœ
    let yMin = -100;
    let yMax = 800;
    
    // å¦‚æœæ•¸æ“šè¶…å‡ºç¯„åœï¼Œå‰‡èª¿æ•´
    if (minVal < -100) {
        yMin = Math.floor(minVal / 100) * 100 - 100;
    }
    if (maxVal > 800) {
        yMax = Math.ceil(maxVal / 100) * 100 + 100;
    }
    
    return { min: yMin, max: yMax };
}

// å¥‘ç´„å®¹é‡ç›£æ§é¡¯ç¤ºå‡½æ•¸
function displayContractMonitor(contractCheck, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    if (!contractCheck) {
        container.innerHTML = '<p class="text-muted">ç„¡å¥‘ç´„å®¹é‡è³‡æ–™</p>';
        return;
    }
    
    const { contract_capacity, total_power_usage, violations, max_power, min_power, avg_power } = contractCheck;
    
    // åˆ¤æ–·æ˜¯å¦ç‚ºè“„é›»æ± ç­–ç•¥å¾Œçš„ç›£æ§
    const isBatteryStrategy = containerId === 'battery-contract-monitor';
    
    let html = `
        <div class="row">
            <div class="col-md-3">
                <div class="card ${max_power > contract_capacity ? 'border-danger' : 'border-success'}">
                    <div class="card-body text-center">
                        <h6>å¥‘ç´„å®¹é‡</h6>
                        <h4 class="text-primary">${contract_capacity} kWh</h4>
                        <small class="text-muted">æ¯å°æ™‚é™åˆ¶</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card ${max_power > contract_capacity ? 'border-danger' : 'border-success'}">
                    <div class="card-body text-center">
                        <h6>æœ€å¤§ç”¨é›»</h6>
                        <h4 class="${max_power > contract_capacity ? 'text-danger' : 'text-success'}">${max_power.toFixed(1)} kWh</h4>
                        <small class="text-muted">${max_power > contract_capacity ? 'âš ï¸ è¶…éé™åˆ¶' : 'âœ… ç¬¦åˆé™åˆ¶'}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h6>å¹³å‡ç”¨é›»</h6>
                        <h4 class="text-info">${avg_power.toFixed(1)} kWh</h4>
                        <small class="text-muted">24å°æ™‚å¹³å‡</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h6>æœ€å°ç”¨é›»</h6>
                        <h4 class="text-warning">${min_power.toFixed(1)} kWh</h4>
                        <small class="text-muted">24å°æ™‚æœ€ä½</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (violations.length > 0) {
        html += `
            <div class="alert alert-danger mt-3">
                <h6>âš ï¸ å¥‘ç´„å®¹é‡é•è¦è­¦å‘Š</h6>
                <p>ç™¼ç¾ ${violations.length} å€‹å°æ™‚è¶…éå¥‘ç´„å®¹é‡é™åˆ¶ï¼š</p>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>å°æ™‚</th>
                                <th>ç¸½ç”¨é›»é‡ (kWh)</th>
                                <th>è¶…å‡ºé‡ (kWh)</th>
                                <th>kpt (kWh)</th>
                                <th>å……é›»é‡ (kWh)</th>
                                <th>æ”¾é›»é‡ (kWh)</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        violations.forEach(violation => {
            html += `
                <tr>
                    <td>${violation.hour}æ™‚</td>
                    <td><strong class="text-danger">${violation.total_power.toFixed(1)}</strong></td>
                    <td><strong class="text-danger">+${violation.excess.toFixed(1)}</strong></td>
                    <td>${violation.kpt.toFixed(1)}</td>
                    <td>${violation.charge.toFixed(1)}</td>
                    <td>${violation.discharge.toFixed(1)}</td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="alert alert-success mt-3">
                <h6>âœ… å¥‘ç´„å®¹é‡ç¬¦åˆ</h6>
                <p>æ‰€æœ‰å°æ™‚çš„ç”¨é›»é‡éƒ½åœ¨å¥‘ç´„å®¹é‡é™åˆ¶å…§ï¼Œæœ€å¤§ç”¨é›»é‡ç‚º ${max_power.toFixed(1)} kWhã€‚</p>
                ${isBatteryStrategy ? '<p><strong>è“„é›»æ± ç­–ç•¥å·²æˆåŠŸé¿å…è¶…éå¥‘ç´„å®¹é‡é™åˆ¶ã€‚</strong></p>' : ''}
            </div>
        `;
    }
    
    // å¦‚æœæ˜¯è“„é›»æ± ç­–ç•¥ï¼ŒåŠ å…¥ç‰¹åˆ¥èªªæ˜
    if (isBatteryStrategy) {
        html += `
            <div class="alert alert-info mt-3">
                <h6>ğŸ”‹ è“„é›»æ± ç­–ç•¥èªªæ˜</h6>
                <p><strong>å¥‘ç´„å®¹é‡å„ªå…ˆï¼š</strong> è“„é›»æ± ç­–ç•¥å„ªå…ˆè€ƒæ…®å¥‘ç´„å®¹é‡é™åˆ¶ï¼Œé¿å…è¶…é785 kWh/å°æ™‚ã€‚</p>
                <p><strong>ç·Šæ€¥è™•ç†ï¼š</strong> ç•¶é æ¸¬æœƒè¶…éå¥‘ç´„å®¹é‡æ™‚ï¼Œç³»çµ±æœƒå¼·åˆ¶æ”¾é›»ä»¥é™ä½é›»ç¶²ç”¨é›»é‡ã€‚</p>
                <p><strong>æ™ºèƒ½èª¿ç¯€ï¼š</strong> åœ¨é›¢å³°æ™‚æ®µå……é›»æ™‚æœƒæª¢æŸ¥æ˜¯å¦æœƒè¶…éå¥‘ç´„å®¹é‡ï¼Œå¿…è¦æ™‚æ¸›å°‘å……é›»é‡ã€‚</p>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// ç”¨é›»é æ¸¬åœ–è¡¨
function renderLatestKptChart(hours, use_pred, kpt_pred, pv_pred) {
    if (latestKptChart) latestKptChart.destroy();
    const ctx = document.getElementById('latestKptChart').getContext('2d');
    
    // å‹•æ…‹èª¿æ•´ Y è»¸ç¯„åœ
    const yAxis = getAdjustedYAxis([use_pred, kpt_pred, pv_pred]);
    
    // å¥‘ç´„å®¹é‡åƒè€ƒç·š
    const contractCapacity = 785;
    const contractLine = new Array(hours.length).fill(contractCapacity);
    
    latestKptChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: hours,
            datasets: [
                {
                    label: 'é æ¸¬è€—é›»é‡ (use)',
                    data: use_pred,
                    borderColor: 'red',
                    fill: false
                },
                {
                    label: 'é æ¸¬ç™¼é›»é‡ (pv)',
                    data: pv_pred,
                    borderColor: 'green',
                    fill: false
                },
                {
                    label: 'é æ¸¬ kpt',
                    data: kpt_pred,
                    borderColor: 'orange',
                    fill: false
                },
                {
                    label: 'å¥‘ç´„å®¹é‡é™åˆ¶',
                    data: contractLine,
                    borderColor: 'blue',
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: {
                x: { title: { display: true, text: 'Hour' } },
                y: {
                    title: { display: true, text: 'kWh' },
                    min: yAxis.min,
                    max: yAxis.max,
                    ticks: { stepSize: 100 }
                }
            }
        }
    });
}
// æ­·å²æŸ¥è©¢åœ–è¡¨
function renderHistoryKptChart(hours, actual_use, actual_kpt, actual_pv, use_pred, kpt_pred, pv_pred) {
    if (historyKptChart) historyKptChart.destroy();
    const ctx = document.getElementById('historyKptChart').getContext('2d');
    
    // å‹•æ…‹èª¿æ•´ Y è»¸ç¯„åœ
    const yAxis = getAdjustedYAxis([actual_use, actual_kpt, actual_pv, use_pred, kpt_pred, pv_pred]);
    
    // å¥‘ç´„å®¹é‡åƒè€ƒç·š
    const contractCapacity = 785;
    const contractLine = new Array(hours.length).fill(contractCapacity);
    
    historyKptChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: hours,
            datasets: [
                {
                    label: 'å¯¦éš›è€—é›»é‡ (use)',
                    data: actual_use,
                    borderColor: 'red',
                    borderDash: [5, 5],
                    fill: false
                },
                {
                    label: 'å¯¦éš›ç™¼é›»é‡ (pv)',
                    data: actual_pv,
                    borderColor: 'green',
                    borderDash: [5, 5],
                    fill: false
                },
                {
                    label: 'å¯¦éš› kpt',
                    data: actual_kpt,
                    borderColor: 'orange',
                    borderDash: [5, 5],
                    fill: false
                },
                {
                    label: 'é æ¸¬è€—é›»é‡ (use)',
                    data: use_pred,
                    borderColor: 'red',
                    fill: false
                },
                {
                    label: 'é æ¸¬ç™¼é›»é‡ (pv)',
                    data: pv_pred,
                    borderColor: 'green',
                    fill: false
                },
                {
                    label: 'é æ¸¬ kpt',
                    data: kpt_pred,
                    borderColor: 'orange',
                    fill: false
                },
                {
                    label: 'å¥‘ç´„å®¹é‡é™åˆ¶',
                    data: contractLine,
                    borderColor: 'blue',
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: {
                x: { title: { display: true, text: 'Hour' } },
                y: {
                    title: { display: true, text: 'kWh' },
                    min: yAxis.min,
                    max: yAxis.max,
                    ticks: { stepSize: 100 }
                }
            }
        }
    });
}

// è“„é›»æ± åˆ†æå‡½æ•¸ - æ”¯æŒæ—¥æœŸç¯„åœï¼ŒåŠ å…¥å¥‘ç´„å®¹é‡è€ƒé‡
function analyzeBatteryStrategy(hours, kpt_pred, dateStr, isLastDay = false, initialBatteryLevel = 0) {
    // åˆ†æç•¶å¤©é›»åƒ¹æ™‚æ®µåˆ†å¸ƒ
    const dailyRates = analyzeDailyRates(dateStr);
    const batteryCapacity = 1260; // ç¸½å®¹é‡
    const maxChargeRate = 200; // æœ€å¤§å……é›»åŠŸç‡
    const maxDischargeRate = 200; // æœ€å¤§æ”¾é›»åŠŸç‡
    const dischargeEfficiency = 0.9; // æ”¾é›»æ•ˆç‡
    const selfDischargeRate = 0.0003; // è‡ªæ”¾é›»æè€— 0.03%
    const contractCapacity = 785; // å¥‘ç´„å®¹é‡é™åˆ¶
    
    let batteryLevel = initialBatteryLevel; // ä½¿ç”¨å‚³å…¥çš„åˆå§‹é›»é‡
    const batteryLevels = [batteryLevel];
    const chargeAmounts = [];
    const dischargeAmounts = [];
    const selfDischargeAmounts = [];
    const gridUsage = [];
    const savings = [];
    const contractViolations = []; // å¥‘ç´„å®¹é‡é•è¦è¨˜éŒ„
    
    // è¨ˆç®—å„æ™‚æ®µé›»åƒ¹
    const rates = hours.map(hour => {
        const date = new Date(dateStr);
        date.setHours(hour);
        return getElectricityRate(date, hour);
    });
    
    // åˆ†ææ¯å€‹å°æ™‚çš„è“„é›»æ± ç­–ç•¥
    for (let i = 0; i < hours.length; i++) {
        const hour = hours[i];
        const kpt = kpt_pred[i];
        const rate = rates[i];
        
        let chargeAmount = 0;
        let dischargeAmount = 0;
        let gridUsageAmount = kpt;
        let hourSavings = 0;
        
        // æ™ºèƒ½è“„é›»æ± ç­–ç•¥ - ä¿æŒå®‰å…¨ç¯„åœ + è‡ªæ”¾é›»æè€—
        const minBatteryLevel = batteryCapacity * 0.1; // æœ€ä½ä¿æŒ10%
        const maxBatteryLevel = batteryCapacity * 0.9; // æœ€é«˜ä¸è¶…é90%
        
        // è¨ˆç®—è‡ªæ”¾é›»æè€—ï¼ˆæ¯å°æ™‚0.03%ï¼‰
        const selfDischarge = batteryLevel * selfDischargeRate;
        batteryLevel = Math.max(0, batteryLevel - selfDischarge); // ç¢ºä¿ä¸æœƒè®Šæˆè² æ•¸
        selfDischargeAmounts.push(selfDischarge);
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºå‡æ—¥ï¼ˆé€±å…­ã€é€±æ—¥ï¼‰
        const isWeekendDay = isWeekend(dateStr);
        
        // å¥‘ç´„å®¹é‡å„ªå…ˆç­–ç•¥ï¼šå…ˆæª¢æŸ¥æ˜¯å¦æœƒè¶…éå¥‘ç´„å®¹é‡
        const potentialGridUsage = kpt + chargeAmount - dischargeAmount;
        
        // æ™ºèƒ½è“„é›»æ± ç­–ç•¥ - å„ªå…ˆé¿å…è¶…éå¥‘ç´„å®¹é‡
        if (rate <= 1.8 && batteryLevel < maxBatteryLevel) {
            // é›¢å³°æ™‚æ®µï¼ˆ1.58å…ƒï¼‰ï¼šå……é›»åˆ°90%ï¼Œç‚ºå°–å³°æ™‚æ®µåšæº–å‚™
            const targetLevel = batteryCapacity * 0.9;
            if (batteryLevel < targetLevel) {
                const neededCharge = targetLevel - batteryLevel;
                const maxPossibleCharge = Math.min(neededCharge, maxChargeRate);
                
                // æª¢æŸ¥å……é›»å¾Œæ˜¯å¦æœƒè¶…éå¥‘ç´„å®¹é‡
                const chargeAfterContract = Math.min(maxPossibleCharge, contractCapacity - kpt);
                chargeAmount = Math.max(0, chargeAfterContract);
                
                if (chargeAmount > 0) {
                    batteryLevel += chargeAmount;
                    gridUsageAmount = kpt + chargeAmount;
                }
            }
        } else if (rate >= 5.0 && batteryLevel > 0) {
            // å°–å³°æ™‚æ®µï¼ˆ5.8å…ƒï¼‰ï¼šå„ªå…ˆä½¿ç”¨è“„é›»æ± ï¼Œæœ€å¤§åŒ–ç¯€çœ
            const neededDischarge = Math.min(kpt, batteryLevel);
            const actualDischarge = Math.min(maxDischargeRate, neededDischarge);
            const effectiveDischarge = actualDischarge * dischargeEfficiency;
            
            if (actualDischarge <= batteryLevel) {
                dischargeAmount = effectiveDischarge;
                batteryLevel -= actualDischarge;
                gridUsageAmount = kpt - effectiveDischarge;
                hourSavings = effectiveDischarge * rate;
            }
        } else if (rate >= 3.0 && rate < 4.0 && batteryLevel > batteryCapacity * 0.5) {
            // åŠå°–å³°æ™‚æ®µï¼ˆ3.63å…ƒï¼‰ï¼šåªæœ‰åœ¨è“„é›»æ± é›»é‡è¶…é50%æ™‚æ‰æ”¾é›»
            // ä¿ç•™é›»é‡çµ¦å°–å³°æ™‚æ®µä½¿ç”¨
            const neededDischarge = Math.min(kpt, batteryLevel * 0.3); // æœ€å¤šä½¿ç”¨30%çš„é›»é‡
            const actualDischarge = Math.min(maxDischargeRate, neededDischarge);
            const effectiveDischarge = actualDischarge * dischargeEfficiency;
            
            if (actualDischarge <= batteryLevel) {
                dischargeAmount = effectiveDischarge;
                batteryLevel -= actualDischarge;
                gridUsageAmount = kpt - effectiveDischarge;
                hourSavings = effectiveDischarge * rate;
            }
        }
        
        // å¥‘ç´„å®¹é‡ç·Šæ€¥è™•ç†ï¼šå¦‚æœä»ç„¶è¶…éå¥‘ç´„å®¹é‡ï¼Œå¼·åˆ¶æ”¾é›»
        if (gridUsageAmount > contractCapacity && batteryLevel > 0) {
            const excessAmount = gridUsageAmount - contractCapacity;
            const neededDischarge = excessAmount / dischargeEfficiency;
            const actualDischarge = Math.min(batteryLevel, neededDischarge);
            const effectiveDischarge = actualDischarge * dischargeEfficiency;
            
            dischargeAmount += effectiveDischarge;
            batteryLevel -= actualDischarge;
            gridUsageAmount = kpt + chargeAmount - dischargeAmount;
            
            // è¨˜éŒ„å¥‘ç´„å®¹é‡é•è¦è™•ç†
            contractViolations.push({
                hour: i,
                originalGridUsage: kpt + chargeAmount,
                finalGridUsage: gridUsageAmount,
                emergencyDischarge: effectiveDischarge,
                excessReduced: excessAmount - (gridUsageAmount - contractCapacity)
            });
        }
        
        // æœ€å¾Œä¸€å¤©çš„æœ€å¾Œä¸€å°æ™‚ï¼šæ¸…ç©ºè“„é›»æ± ï¼Œä¸ç•™é›»
        if (isLastDay && i === hours.length - 1 && batteryLevel > 0) {
            // å¼·åˆ¶æ¸…ç©ºæ‰€æœ‰å‰©é¤˜é›»é‡
            const finalActualDischarge = batteryLevel;
            const finalEffectiveDischarge = finalActualDischarge * dischargeEfficiency;
            
            dischargeAmount += finalEffectiveDischarge;
            batteryLevel = 0; // å®Œå…¨æ¸…ç©º
            gridUsageAmount = kpt + chargeAmount - dischargeAmount;
            hourSavings += finalEffectiveDischarge * rate;
        }
        
        batteryLevels.push(batteryLevel);
        chargeAmounts.push(chargeAmount);
        dischargeAmounts.push(dischargeAmount);
        gridUsage.push(gridUsageAmount);
        savings.push(hourSavings);
    }
    
    // è¨ˆç®—ç¸½ç¯€çœé‡‘é¡
    const totalSavings = savings.reduce((sum, val) => sum + val, 0);
    const totalGridUsage = gridUsage.reduce((sum, val) => sum + val, 0);
    const originalCost = kpt_pred.reduce((sum, val, i) => sum + val * rates[i], 0);
    const newCost = gridUsage.reduce((sum, val, i) => sum + val * rates[i], 0);
    const netSavings = originalCost - newCost;
    
    // åˆ†æå„æ™‚æ®µç¯€çœæ•ˆæœ
    const peakSavings = savings.reduce((sum, val, i) => {
        return rates[i] >= 5.0 ? sum + val : sum;
    }, 0);
    const halfPeakSavings = savings.reduce((sum, val, i) => {
        return rates[i] >= 3.0 && rates[i] < 4.0 ? sum + val : sum;
    }, 0);
    const offPeakSavings = savings.reduce((sum, val, i) => sum + val, 0);
    
    // è¨ˆç®—æ–°çš„çµ±è¨ˆé …ç›®
    const totalPurchasePower = chargeAmounts.reduce((sum, val) => sum + val, 0); // ç¸½è³¼é›»é‡
    const batteryElectricityCost = totalPurchasePower * 1.58; // è“„é›»æ± é›»è²»ï¼ˆä»¥é›¢å³°é›»åƒ¹è¨ˆç®—ï¼‰
    const totalLoss = selfDischargeAmounts.reduce((sum, val) => sum + val, 0); // ç¸½æè€—
    const totalSavingsAmount = savings.reduce((sum, val) => sum + val, 0); // ç¯€ç´„é‡‘é¡
    
    // è¨ˆç®—å¯¦éš›æ”¾é›»é‡ï¼ˆè€ƒæ…®æ•ˆç‡ï¼‰
    const totalEffectiveDischarge = dischargeAmounts.reduce((sum, val) => sum + val, 0); // æœ‰æ•ˆæ”¾é›»é‡
    const totalBatteryDischarge = totalEffectiveDischarge / dischargeEfficiency; // å¯¦éš›å¾è“„é›»æ± æ”¾å‡ºçš„é›»é‡
    
    // è¨ˆç®—å‰©é¤˜é›»é‡ï¼ˆå¦‚æœæ²’æœ‰å®Œå…¨æ¸…ç©ºï¼‰
    const remainingBatteryLevel = batteryLevel;
    
    // å¥‘ç´„å®¹é‡æª¢æŸ¥
    const contractCheck = {
        contract_capacity: contractCapacity,
        total_power_usage: gridUsage,
        violations: contractViolations.map(v => ({
            hour: v.hour,
            total_power: v.originalGridUsage,
            excess: v.originalGridUsage - contractCapacity,
            emergency_discharge: v.emergencyDischarge,
            excess_reduced: v.excessReduced
        })),
        max_power: Math.max(...gridUsage),
        min_power: Math.min(...gridUsage),
        avg_power: gridUsage.reduce((sum, val) => sum + val, 0) / gridUsage.length
    };
    
    return {
        batteryLevels: batteryLevels.slice(0, -1), // ç§»é™¤æœ€å¾Œä¸€å€‹å€¼
        chargeAmounts,
        dischargeAmounts,
        selfDischargeAmounts,
        gridUsage,
        savings,
        totalSavings,
        totalGridUsage,
        originalCost,
        newCost,
        netSavings,
        peakSavings,
        halfPeakSavings,
        offPeakSavings,
        totalPurchasePower,
        batteryElectricityCost,
        totalLoss,
        totalSavingsAmount,
        totalEffectiveDischarge, // æœ‰æ•ˆæ”¾é›»é‡
        totalBatteryDischarge, // å¯¦éš›å¾è“„é›»æ± æ”¾å‡ºçš„é›»é‡
        remainingBatteryLevel, // å‰©é¤˜é›»é‡
        dailyRates, // ç•¶å¤©é›»åƒ¹æ™‚æ®µåˆ†æ
        finalBatteryLevel: batteryLevel,
        contractCheck, // å¥‘ç´„å®¹é‡æª¢æŸ¥çµæœ
        contractViolations // å¥‘ç´„å®¹é‡é•è¦è™•ç†è¨˜éŒ„
    };
}

// æª¢æŸ¥æ˜¯å¦ç‚ºå‡æ—¥
function isWeekend(dateStr) {
    const date = new Date(dateStr);
    return date.getDay() === 0 || date.getDay() === 6; // 0=é€±æ—¥, 6=é€±å…­
}

// åˆ†æç•¶å¤©é›»åƒ¹æ™‚æ®µåˆ†å¸ƒ
function analyzeDailyRates(dateStr) {
    const rates = [];
    const rateTypes = [];
    
    for (let hour = 0; hour < 24; hour++) {
        const date = new Date(dateStr);
        date.setHours(hour);
        const rate = getElectricityRate(date, hour);
        rates.push(rate);
        
        if (rate >= 5.0) {
            rateTypes.push({ hour, rate, type: 'å°–å³°', color: 'red' });
        } else if (rate >= 3.0 && rate < 4.0) {
            rateTypes.push({ hour, rate, type: 'åŠå°–å³°', color: 'orange' });
        } else {
            rateTypes.push({ hour, rate, type: 'é›¢å³°', color: 'green' });
        }
    }
    
    return {
        rates,
        rateTypes,
        peakHours: rateTypes.filter(r => r.type === 'å°–å³°').map(r => r.hour),
        halfPeakHours: rateTypes.filter(r => r.type === 'åŠå°–å³°').map(r => r.hour),
        offPeakHours: rateTypes.filter(r => r.type === 'é›¢å³°').map(r => r.hour)
    };
}

// å–å¾—é›»åƒ¹å‡½æ•¸
function getElectricityRate(date, hour) {
    function isSummer(date) {
        const m = date.getMonth() + 1;
        const d = date.getDate();
        if (m > 5 && m < 10) return true;
        if (m === 5 && d >= 16) return true;
        if (m === 10 && d <= 15) return true;
        return false;
    }
    
    function getTimeType(date, hour) {
        const wd = date.getDay(); // 0=Sun, 6=Sat
        const summer = isSummer(date);
        if (wd >= 1 && wd <= 5) { // å¹³æ—¥
            if (summer) {
                if (hour >= 16 && hour < 22) return 5.8;
                if ((hour >= 9 && hour < 16) || (hour >= 22 && hour < 24)) return 3.63;
                return 1.58;
            } else {
                if ((hour >= 6 && hour < 11) || (hour >= 14 && hour < 24)) return 3.4;
                return 1.45;
            }
        } else if (wd === 6) { // é€±å…­
            if (summer) {
                if (hour >= 9 && hour < 24) return 1.78;
                return 1.58;
            } else {
                if ((hour >= 6 && hour < 11) || (hour >= 14 && hour < 24)) return 1.65;
                return 1.45;
            }
        } else { // é€±æ—¥
            if (summer) return 1.58;
            return 1.45;
        }
    }
    
    return getTimeType(date, hour);
}

// æ¸²æŸ“è“„é›»æ± åœ–è¡¨
function renderBatteryChart(hours, kpt_pred, batteryData) {
    try {
        if (batteryChart) batteryChart.destroy();
        const ctx = document.getElementById('batteryChart').getContext('2d');
        
        // å‹•æ…‹èª¿æ•´ Y è»¸ç¯„åœ
        const yAxis = getAdjustedYAxis([kpt_pred, batteryData.batteryLevels, batteryData.gridUsage]);
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºå–®æ—¥é¡¯ç¤º
        const isSingleDay = hours.length <= 24;
        const xAxisTitle = isSingleDay ? 'Hour' : 'Time';
        const xAxisMin = isSingleDay ? 0 : undefined;
        const xAxisMax = isSingleDay ? 23 : undefined;
        
        // å¥‘ç´„å®¹é‡åƒè€ƒç·š
        const contractCapacity = 785;
        const contractLine = new Array(hours.length).fill(contractCapacity);
        
        batteryChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: hours,
                datasets: [
                    {
                        label: 'é æ¸¬ kpt',
                        data: kpt_pred,
                        borderColor: 'orange',
                        fill: false
                    },
                    {
                        label: 'è“„é›»æ± é›»é‡',
                        data: batteryData.batteryLevels,
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        fill: true
                    },
                    {
                        label: 'é›»ç¶²ç”¨é›»é‡',
                        data: batteryData.gridUsage,
                        borderColor: 'red',
                        borderDash: [3, 3],
                        fill: false
                    },
                    {
                        label: 'å¥‘ç´„å®¹é‡é™åˆ¶',
                        data: contractLine,
                        borderColor: 'blue',
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    },
                    {
                        label: 'å……é›»é‡',
                        data: batteryData.chargeAmounts,
                        borderColor: 'purple',
                        borderDash: [5, 5],
                        fill: false
                    },
                    {
                        label: 'æ”¾é›»é‡',
                        data: batteryData.dischargeAmounts,
                        borderColor: 'brown',
                        borderDash: [5, 5],
                        fill: false
                    },
                    {
                        label: 'è‡ªæ”¾é›»æè€—',
                        data: batteryData.selfDischargeAmounts,
                        borderColor: 'gray',
                        borderDash: [2, 2],
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true },
                    title: { 
                        display: true, 
                        text: isSingleDay ? 
                            `è“„é›»æ± ç­–ç•¥åˆ†æ - ${dateRangeData ? dateRangeData[currentDayIndex].date : ''} (å–®æ—¥)` :
                            'è“„é›»æ± ç­–ç•¥åˆ†æ - åŸºæ–¼ kpt é æ¸¬ï¼ˆæ™‚é–“å€é–“ç­–ç•¥ï¼‰'
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: xAxisTitle },
                        min: xAxisMin,
                        max: xAxisMax
                    },
                    y: {
                        title: { display: true, text: 'kWh' },
                        min: yAxis.min,
                        max: yAxis.max,
                        ticks: { stepSize: 100 }
                    }
                }
            }
        });
    } catch (error) {
        console.error('è“„é›»æ± åœ–è¡¨æ¸²æŸ“éŒ¯èª¤:', error);
        alert('åœ–è¡¨æ¸²æŸ“å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤ä¿¡æ¯');
    }
}

// åˆ†æ™‚æ®µè¨ˆè²»è¨ˆç®—
function renderBillSummary(hours, actual, dateStr) {
    // å°–å³°ã€åŠå°–å³°ã€é›¢å³°æ™‚æ®µå®šç¾©èˆ‡é›»åƒ¹
    // èˆ‡ calc_bill.py ä¿æŒä¸€è‡´
    function isSummer(date) {
        const m = date.getMonth() + 1;
        const d = date.getDate();
        if (m > 5 && m < 10) return true;
        if (m === 5 && d >= 16) return true;
        if (m === 10 && d <= 15) return true;
        return false;
    }
    function getTimeType(date, hour) {
        const wd = date.getDay(); // 0=Sun, 6=Sat
        const summer = isSummer(date);
        if (wd >= 1 && wd <= 5) { // å¹³æ—¥
            if (summer) {
                if (hour >= 16 && hour < 22) return ['peak', 5.8];
                if ((hour >= 9 && hour < 16) || (hour >= 22 && hour < 24)) return ['half_peak', 3.63];
                return ['off_peak', 1.58];
            } else {
                if ((hour >= 6 && hour < 11) || (hour >= 14 && hour < 24)) return ['half_peak', 3.4];
                return ['off_peak', 1.45];
            }
        } else if (wd === 6) { // é€±å…­
            if (summer) {
                if (hour >= 9 && hour < 24) return ['half_peak', 1.78];
                return ['off_peak', 1.58];
            } else {
                if ((hour >= 6 && hour < 11) || (hour >= 14 && hour < 24)) return ['half_peak', 1.65];
                return ['off_peak', 1.45];
            }
        } else { // é€±æ—¥
            if (summer) return ['off_peak', 1.58];
            return ['off_peak', 1.45];
        }
    }
    let peakKwh = 0, halfPeakKwh = 0, offPeakKwh = 0;
    let peakFee = 0, halfPeakFee = 0, offPeakFee = 0;
    for (let i = 0; i < hours.length; i++) {
        const hour = hours[i];
        const kwh = actual[i];
        const date = new Date(dateStr);
        date.setHours(hour);
        const [ttype, rate] = getTimeType(date, hour);
        if (ttype === 'peak') {
            peakKwh += kwh;
            peakFee += kwh * rate;
        } else if (ttype === 'half_peak') {
            halfPeakKwh += kwh;
            halfPeakFee += kwh * rate;
        } else {
            offPeakKwh += kwh;
            offPeakFee += kwh * rate;
        }
    }
    document.getElementById('peak-kwh').innerText = peakKwh.toFixed(2);
    document.getElementById('peak-fee').innerText = peakFee.toFixed(2);
    document.getElementById('halfpeak-kwh').innerText = halfPeakKwh.toFixed(2);
    document.getElementById('halfpeak-fee').innerText = halfPeakFee.toFixed(2);
    document.getElementById('offpeak-kwh').innerText = offPeakKwh.toFixed(2);
    document.getElementById('offpeak-fee').innerText = offPeakFee.toFixed(2);
}

// è¼‰å…¥ç”¨é›»é æ¸¬åˆ†é åœ–è¡¨
function loadLatestKpt() {
    fetch('/latest_predict')
        .then(res => res.json())
        .then(data => {
            renderLatestKptChart(data.hours, data.use_pred, data.kpt_pred, data.pv_pred);
            // é¡¯ç¤ºå¥‘ç´„å®¹é‡ç›£æ§
            if (data.contract_check) {
                displayContractMonitor(data.contract_check, 'contract-monitor');
            }
        });
}
// æ­·å²æŸ¥è©¢åˆ†é æŸ¥è©¢
function loadHistoryDates() {
    fetch('/dates')
        .then(res => res.json())
        .then(data => {
            const picker = document.getElementById('history-date-picker');
            if (data.length === 0) {
                picker.disabled = true;
                return;
            }
            picker.disabled = false;
            picker.min = data[0];
            picker.max = data[data.length-1];
            picker.value = data[data.length-1];
        });
}

// æ¸…é™¤è¨ˆè²»æ‘˜è¦
function clearHistoryBillSummary() {
    document.getElementById('peak-kwh').innerText = '--';
    document.getElementById('peak-fee').innerText = '--';
    document.getElementById('halfpeak-kwh').innerText = '--';
    document.getElementById('halfpeak-fee').innerText = '--';
    document.getElementById('offpeak-kwh').innerText = '--';
    document.getElementById('offpeak-fee').innerText = '--';
}

// æª”æ¡ˆä¸Šå‚³ç›¸é—œåŠŸèƒ½
function setupFileUpload() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn');
    const uploadStatus = document.getElementById('upload-status');

    // æ‹–æ‹½ä¸Šå‚³
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });

    // é»æ“Šä¸Šå‚³
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });

    // ä¸Šå‚³æŒ‰éˆ•
    uploadBtn.addEventListener('click', uploadAndPredict);
}

function handleFileSelect(file) {
    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('è«‹é¸æ“‡ CSV æª”æ¡ˆ');
        return;
    }

    uploadedFile = file;
    document.getElementById('upload-btn').disabled = false;
    document.getElementById('upload-status').innerHTML = `
        <div class="alert alert-info">
            <strong>å·²é¸æ“‡æª”æ¡ˆï¼š</strong> ${file.name}<br>
            <small>æª”æ¡ˆå¤§å°ï¼š${(file.size / 1024).toFixed(2)} KB</small>
        </div>
    `;
}

function uploadAndPredict() {
    if (!uploadedFile) {
        alert('è«‹å…ˆé¸æ“‡æª”æ¡ˆ');
        return;
    }

    const formData = new FormData();
    formData.append('file', uploadedFile);

    const uploadBtn = document.getElementById('upload-btn');
    const uploadStatus = document.getElementById('upload-status');

    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> é æ¸¬ä¸­...';
    uploadStatus.innerHTML = '<div class="alert alert-warning">æ­£åœ¨é€²è¡Œé æ¸¬ï¼Œè«‹ç¨å€™...</div>';

    fetch('/upload_predict', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        predictionResults = data.results;
        displayPredictionResults(data);
        uploadStatus.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
    })
    .catch(error => {
        console.error('é æ¸¬å¤±æ•—:', error);
        uploadStatus.innerHTML = `<div class="alert alert-danger">é æ¸¬å¤±æ•—ï¼š${error.message}</div>`;
    })
    .finally(() => {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = 'é–‹å§‹é æ¸¬';
    });
}

function displayPredictionResults(data) {
    const resultsDiv = document.getElementById('upload-results');
    const resultsTable = document.getElementById('upload-results-table');
    const tbody = document.getElementById('results-tbody');

    // æª¢æŸ¥æ˜¯å¦æœ‰å¯¦éš› kpt æ•¸æ“š
    const hasActual = data.results.some(r => r.actual_kpt !== undefined);
    
    // ä¿å­˜æ‰€æœ‰æ•¸æ“š
    allPredictionResults = data.results;
    predictionResults = data.results;
    
    // é¡¯ç¤ºåŸºæœ¬çµæœ
    resultsDiv.innerHTML = `
        <div class="alert alert-success">
            <h6>é æ¸¬å®Œæˆï¼</h6>
            <p>ç¸½å…±è™•ç† ${data.results.length} ç­†è³‡æ–™</p>
            <p>é æ¸¬ç¯„åœï¼š${data.results[0].date} åˆ° ${data.results[data.results.length-1].date}</p>
            <p>åŒ…å«å¯¦éš›å€¼ï¼š${hasActual ? 'æ˜¯' : 'å¦'}</p>
        </div>
    `;

    // è¨­å®šæ—¥æœŸé¸æ“‡å™¨çš„å¯ç”¨æ—¥æœŸ
    const dates = [...new Set(data.results.map(r => r.date))];
    const datePicker = document.getElementById('upload-date-picker');
    if (dates.length > 0) {
        datePicker.min = dates[0];
        datePicker.max = dates[dates.length - 1];
        datePicker.value = dates[0]; // é è¨­é¸æ“‡ç¬¬ä¸€å€‹æ—¥æœŸ
        document.getElementById('change-date-btn').disabled = false;
    }

    // é¡¯ç¤ºè©³ç´°è¡¨æ ¼
    updateResultsTable(data.results);
    resultsTable.style.display = 'block';

    // æ›´æ–°åœ–è¡¨
    updateUploadChart();

    // è¨­å®šä¸‹è¼‰æŒ‰éˆ•
    setupDownloadButton(data.results);
    
    // é¡¯ç¤ºå¥‘ç´„å®¹é‡ç›£æ§
    if (data.contract_check) {
        displayContractMonitor(data.contract_check, 'upload-contract-monitor');
    }
}

function updateUploadChart() {
    if (!predictionResults) return;
    if (uploadKptChart) uploadKptChart.destroy();
    const ctx = document.getElementById('uploadKptChart').getContext('2d');
    const hours = predictionResults.map(r => r.hour);
    const use_pred = predictionResults.map(r => r.use_pred);
    const pv_pred = predictionResults.map(r => r.pv_pred);
    const kpt_pred = predictionResults.map(r => r.kpt_pred);
    
    // å‹•æ…‹èª¿æ•´ Y è»¸ç¯„åœ
    const yAxis = getAdjustedYAxis([use_pred, pv_pred, kpt_pred]);
    
    // å¥‘ç´„å®¹é‡åƒè€ƒç·š
    const contractCapacity = 785;
    const contractLine = new Array(hours.length).fill(contractCapacity);
    
    let datasets = [
        {
            label: 'é æ¸¬è€—é›»é‡ (use)',
            data: use_pred,
            borderColor: 'red',
            fill: false
        },
        {
            label: 'é æ¸¬ç™¼é›»é‡ (pv)',
            data: pv_pred,
            borderColor: 'green',
            fill: false
        },
        {
            label: 'é æ¸¬ kpt',
            data: kpt_pred,
            borderColor: 'orange',
            fill: false
        },
        {
            label: 'å¥‘ç´„å®¹é‡é™åˆ¶',
            data: contractLine,
            borderColor: 'blue',
            borderDash: [5, 5],
            fill: false,
            pointRadius: 0
        }
    ];
    uploadKptChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: hours,
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true },
                title: { display: true, text: 'ä¸Šå‚³è³‡æ–™é æ¸¬çµæœ' }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Hour' },
                    min: 0,
                    max: 23
                },
                y: {
                    title: { display: true, text: 'kWh' },
                    min: yAxis.min,
                    max: yAxis.max,
                    ticks: { stepSize: 100 }
                }
            }
        }
    });
}

function setupDownloadButton(results) {
    document.getElementById('download-csv-btn').onclick = function() {
        // å»ºç«‹ CSV å…§å®¹
        const csvContent = [
            'Date,Hour,Temperature,Humidity,Rain,day_week,Predicted_use,Predicted_pv,Predicted_kpt',
            ...results.map(r => `${r.date},${r.hour},${r.temperature},${r.humidity},${r.rain},${r.day_week},${r.use_pred},${r.pv_pred},${r.kpt_pred}`)
        ].join('\n');
        // å»ºç«‹ä¸‹è¼‰é€£çµ
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'prediction_results.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
}

// æ­·å²æŸ¥è©¢æŒ‰éˆ•äº‹ä»¶
document.getElementById('history-query-btn').onclick = function() {
    const date = document.getElementById('history-date-picker').value;
    fetch(`/predict?date=${date}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            renderHistoryKptChart(
                data.hours,
                data.actual_use,
                data.actual_kpt,
                data.actual_pv,
                data.use_pred,
                data.kpt_pred,
                data.pv_pred
            );
            renderBillSummary(data.hours, data.actual_kpt, date);
            // é¡¯ç¤ºå¥‘ç´„å®¹é‡ç›£æ§
            if (data.contract_check) {
                displayContractMonitor(data.contract_check, 'history-contract-monitor');
            }
        });
};

// æ—¥æœŸé¸æ“‡å™¨ç›¸é—œåŠŸèƒ½
function setupDateSelector() {
    const uploadDatePicker = document.getElementById('upload-date-picker');
    const changeDateBtn = document.getElementById('change-date-btn');
    
    uploadDatePicker.addEventListener('change', function() {
        changeDateBtn.disabled = false;
    });

    changeDateBtn.addEventListener('click', function() {
        const selectedDate = uploadDatePicker.value;
        if (!selectedDate || !allPredictionResults) {
            alert('è«‹å…ˆé¸æ“‡æ—¥æœŸ');
            return;
        }
        
        // å¾æ‰€æœ‰æ•¸æ“šä¸­éæ¿¾é¸å®šæ—¥æœŸçš„æ•¸æ“š
        const filteredResults = allPredictionResults.filter(r => r.date === selectedDate);
        
        if (filteredResults.length === 0) {
            alert('é¸å®šæ—¥æœŸæ²’æœ‰æ•¸æ“š');
            return;
        }
        
        // æ›´æ–°ç•¶å‰é¡¯ç¤ºçš„æ•¸æ“š
        predictionResults = filteredResults;
        updateUploadChart();
        updateResultsTable(filteredResults);
    });
}

function updateResultsTable(results) {
    const tbody = document.getElementById('results-tbody');
    tbody.innerHTML = '';
    results.forEach(result => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${result.date}</td>
            <td>${result.hour}</td>
            <td><strong style='color:red'>${result.use_pred}</strong></td>
            <td><strong style='color:green'>${result.pv_pred}</strong></td>
            <td><strong style='color:orange'>${result.kpt_pred}</strong></td>
        `;
    });
}



// è“„é›»æ± åˆ†ææŒ‰éˆ•äº‹ä»¶ - æ”¯æŒæ—¥æœŸç¯„åœ
document.getElementById('battery-query-btn').onclick = function() {
    const startDate = document.getElementById('battery-start-date').value;
    const endDate = document.getElementById('battery-end-date').value;
    
    if (!startDate || !endDate) {
        alert('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ');
        return;
    }
    
    if (startDate > endDate) {
        alert('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');
        return;
    }
    
    console.log('é–‹å§‹åˆ†æè“„é›»æ± ç­–ç•¥ï¼Œæ—¥æœŸç¯„åœ:', startDate, 'åˆ°', endDate);
    
    // åˆ†ææ—¥æœŸç¯„åœ
    analyzeDateRange(startDate, endDate);
};

// åˆ†ææ—¥æœŸç¯„åœçš„å‡½æ•¸
async function analyzeDateRange(startDate, endDate) {
    try {
        // ç”Ÿæˆæ—¥æœŸç¯„åœ
        const dateRange = [];
        const currentDate = new Date(startDate);
        const endDateObj = new Date(endDate);
        
        while (currentDate <= endDateObj) {
            dateRange.push(currentDate.toISOString().split('T')[0]);
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        console.log('æ—¥æœŸç¯„åœ:', dateRange);
        
        // æ”¶é›†æ‰€æœ‰æ—¥æœŸçš„æ•¸æ“š
        const allData = [];
        let currentBatteryLevel = 0; // ç¬¬ä¸€å¤©åˆå§‹é›»é‡ç‚º0
        
        for (let i = 0; i < dateRange.length; i++) {
            const date = dateRange[i];
            const isLastDay = i === dateRange.length - 1;
            
            const response = await fetch(`/predict?date=${date}`);
            const data = await response.json();
            
            if (data.error) {
                alert(`æ—¥æœŸ ${date} çš„æ•¸æ“šéŒ¯èª¤: ${data.error}`);
                return;
            }
            
            console.log(`åˆ†ææ—¥æœŸ ${date}ï¼Œåˆå§‹é›»é‡: ${currentBatteryLevel.toFixed(1)} kWh`);
            
            // é€²è¡Œè“„é›»æ± ç­–ç•¥åˆ†æï¼Œå‚³å…¥å‰ä¸€å¤©çš„å‰©é¤˜é›»é‡
            const batteryData = analyzeBatteryStrategy(
                data.hours,
                data.kpt_pred,
                date,
                isLastDay,
                currentBatteryLevel
            );
            
            // ç´¯ç©çµ±è¨ˆæ•¸æ“š
            allData.push({
                date: date,
                hours: data.hours,
                kpt_pred: data.kpt_pred,
                batteryData: batteryData,
                initialBatteryLevel: currentBatteryLevel
            });
            
            // æ›´æ–°ä¸‹ä¸€å¤©çš„åˆå§‹é›»é‡ï¼ˆç¹¼æ‰¿å‰ä¸€å¤©çš„å‰©é¤˜é›»é‡ï¼‰
            currentBatteryLevel = batteryData.finalBatteryLevel;
            console.log(`æ—¥æœŸ ${date} çµæŸï¼Œå‰©é¤˜é›»é‡: ${currentBatteryLevel.toFixed(1)} kWh`);
        }
        
        // ä¿å­˜æ—¥æœŸç¯„åœæ•¸æ“šä¾›åˆ‡æ›ä½¿ç”¨
        dateRangeData = allData;
        currentDayIndex = 0;
        
        // åˆä½µæ‰€æœ‰æ•¸æ“šé€²è¡Œç¸½é«”åˆ†æ
        const combinedData = combineDateRangeData(allData);
        
        console.log('åˆä½µåˆ†ææ•¸æ“š:', combinedData);
        
        // æ›´æ–°ä»‹é¢
        updateBatteryStatus(combinedData, `${startDate} åˆ° ${endDate}`);
        updateBatteryAnalysis(combinedData);
        renderBatteryChart(combinedData.allHours, combinedData.allKptPred, combinedData);
        updateBatteryDetails(combinedData.allHours, combinedData, `${startDate} åˆ° ${endDate}`);
        
        // é¡¯ç¤ºå¥‘ç´„å®¹é‡ç›£æ§
        if (combinedData.contractCheck) {
            displayContractMonitor(combinedData.contractCheck, 'battery-contract-monitor');
        }
        
        // å•Ÿç”¨åˆ‡æ›æŒ‰éˆ•ä¸¦é¡¯ç¤ºç•¶å‰æ—¥æœŸ
        updateDayNavigation();
        
        console.log('æ—¥æœŸç¯„åœåˆ†æå®Œæˆ');
        
    } catch (error) {
        console.error('æ—¥æœŸç¯„åœåˆ†æéŒ¯èª¤:', error);
        alert('åˆ†æå¤±æ•—ï¼š' + error.message);
    }
}

// åˆä½µæ—¥æœŸç¯„åœæ•¸æ“šçš„å‡½æ•¸
function combineDateRangeData(allData) {
    const combined = {
        allHours: [],
        allKptPred: [],
        batteryLevels: [],
        chargeAmounts: [],
        dischargeAmounts: [],
        selfDischargeAmounts: [],
        gridUsage: [],
        savings: [],
        totalSavings: 0,
        totalGridUsage: 0,
        originalCost: 0,
        newCost: 0,
        netSavings: 0,
        peakSavings: 0,
        halfPeakSavings: 0,
        offPeakSavings: 0,
        totalPurchasePower: 0,
        batteryElectricityCost: 0,
        totalLoss: 0,
        totalSavingsAmount: 0,
        finalBatteryLevel: 0,
        contractCheck: null,
        contractViolations: []
    };
    
    // åˆä½µæ‰€æœ‰æ—¥æœŸçš„æ•¸æ“š
    allData.forEach((dayData, dayIndex) => {
        const { hours, kpt_pred, batteryData } = dayData;
        
        // æ·»åŠ å°æ™‚å’Œé æ¸¬æ•¸æ“š
        hours.forEach((hour, hourIndex) => {
            combined.allHours.push(`${dayData.date} ${hour}:00`);
            combined.allKptPred.push(kpt_pred[hourIndex]);
        });
        
        // åˆä½µè“„é›»æ± æ•¸æ“š
        combined.batteryLevels.push(...batteryData.batteryLevels);
        combined.chargeAmounts.push(...batteryData.chargeAmounts);
        combined.dischargeAmounts.push(...batteryData.dischargeAmounts);
        combined.selfDischargeAmounts.push(...batteryData.selfDischargeAmounts);
        combined.gridUsage.push(...batteryData.gridUsage);
        combined.savings.push(...batteryData.savings);
        
        // ç´¯ç©çµ±è¨ˆæ•¸æ“š
        combined.totalSavings += batteryData.totalSavings;
        combined.totalGridUsage += batteryData.totalGridUsage;
        combined.originalCost += batteryData.originalCost;
        combined.newCost += batteryData.newCost;
        combined.peakSavings += batteryData.peakSavings;
        combined.halfPeakSavings += batteryData.halfPeakSavings;
        combined.offPeakSavings += batteryData.offPeakSavings;
        combined.totalPurchasePower += batteryData.totalPurchasePower;
        combined.batteryElectricityCost += batteryData.batteryElectricityCost;
        combined.totalLoss += batteryData.totalLoss;
        combined.totalSavingsAmount += batteryData.totalSavingsAmount;
        
        // æœ€å¾Œä¸€å¤©çš„é›»é‡
        if (dayIndex === allData.length - 1) {
            combined.finalBatteryLevel = batteryData.finalBatteryLevel;
        }
        
        // åˆä½µå¥‘ç´„å®¹é‡ç›¸é—œæ•¸æ“š
        if (batteryData.contractCheck) {
            combined.contractCheck = batteryData.contractCheck;
        }
        if (batteryData.contractViolations) {
            combined.contractViolations.push(...batteryData.contractViolations);
        }
    });
    
    // è¨ˆç®—æ·¨ç¯€çœ
    combined.netSavings = combined.originalCost - combined.newCost;
    
    return combined;
}

// æ›´æ–°æ—¥æœŸå°èˆª
function updateDayNavigation() {
    const prevBtn = document.getElementById('prev-day-btn');
    const nextBtn = document.getElementById('next-day-btn');
    const overviewBtn = document.getElementById('overview-btn');
    const dayDisplay = document.getElementById('current-day-display');
    
    if (!dateRangeData || dateRangeData.length === 0) {
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        overviewBtn.disabled = true;
        dayDisplay.textContent = 'è«‹å…ˆåˆ†ææ™‚é–“å€é–“';
        return;
    }
    
    prevBtn.disabled = currentDayIndex === 0;
    nextBtn.disabled = currentDayIndex === dateRangeData.length - 1;
    overviewBtn.disabled = false;
    
    const currentDay = dateRangeData[currentDayIndex];
    dayDisplay.textContent = `ç•¶å‰é¡¯ç¤ºï¼š${currentDay.date} (${currentDayIndex + 1}/${dateRangeData.length})`;
}

// é¡¯ç¤ºæŒ‡å®šæ—¥æœŸçš„æ•¸æ“š
function showDayData(dayIndex) {
    if (!dateRangeData || dayIndex < 0 || dayIndex >= dateRangeData.length) {
        return;
    }
    
    currentDayIndex = dayIndex;
    const dayData = dateRangeData[dayIndex];
    
    // æ›´æ–°åœ–è¡¨é¡¯ç¤ºå–®æ—¥æ•¸æ“š
    renderBatteryChart(
        dayData.hours,
        dayData.kpt_pred,
        dayData.batteryData
    );
    
    // æ›´æ–°è©³ç´°åˆ†æé¡¯ç¤ºå–®æ—¥æ•¸æ“š
    updateBatteryDetails(dayData.hours, dayData.batteryData, dayData.date);
    
    // é¡¯ç¤ºå¥‘ç´„å®¹é‡ç›£æ§
    if (dayData.batteryData.contractCheck) {
        displayContractMonitor(dayData.batteryData.contractCheck, 'battery-contract-monitor');
    }
    
    // æ›´æ–°å°èˆªç‹€æ…‹
    updateDayNavigation();
    
    // é¡¯ç¤ºåˆå§‹é›»é‡ä¿¡æ¯
    const initialLevel = dayData.initialBatteryLevel || 0;
    document.getElementById('current-day-display').textContent = 
        `${dayData.date} (åˆå§‹é›»é‡: ${initialLevel.toFixed(1)} kWh)`;
}

// å‰ä¸€å¤©æŒ‰éˆ•äº‹ä»¶
document.getElementById('prev-day-btn').onclick = function() {
    if (currentDayIndex > 0) {
        showDayData(currentDayIndex - 1);
    }
};

// å¾Œä¸€å¤©æŒ‰éˆ•äº‹ä»¶
document.getElementById('next-day-btn').onclick = function() {
    if (currentDayIndex < dateRangeData.length - 1) {
        showDayData(currentDayIndex + 1);
    }
};

// ç¸½é«”è¦–åœ–æŒ‰éˆ•äº‹ä»¶
document.getElementById('overview-btn').onclick = function() {
    if (!dateRangeData || dateRangeData.length === 0) {
        return;
    }
    
    // é¡¯ç¤ºç¸½é«”è¦–åœ–
    const combinedData = combineDateRangeData(dateRangeData);
    const startDate = dateRangeData[0].date;
    const endDate = dateRangeData[dateRangeData.length - 1].date;
    
    renderBatteryChart(combinedData.allHours, combinedData.allKptPred, combinedData);
    updateBatteryDetails(combinedData.allHours, combinedData, `${startDate} åˆ° ${endDate}`);
    
    // é¡¯ç¤ºå¥‘ç´„å®¹é‡ç›£æ§
    if (combinedData.contractCheck) {
        displayContractMonitor(combinedData.contractCheck, 'battery-contract-monitor');
    }
    
    // æ›´æ–°é¡¯ç¤ºç‹€æ…‹
    document.getElementById('current-day-display').textContent = `ç¸½é«”è¦–åœ–ï¼š${startDate} åˆ° ${endDate} (æ™‚é–“å€é–“åˆ†æ)`;
};

// æ›´æ–°è“„é›»æ± ç‹€æ…‹
function updateBatteryStatus(batteryData, dateStr) {
    // é˜²è­·æª¢æŸ¥
    if (!batteryData || typeof batteryData !== 'object') {
        console.error('batteryData ç‚ºç©ºæˆ–ç„¡æ•ˆ');
        return;
    }
    
    const finalBatteryLevel = batteryData.finalBatteryLevel || 0;
    const percentage = Math.round((finalBatteryLevel / 1260) * 100);
    const progressBar = document.getElementById('battery-level');
    const currentLevel = document.getElementById('battery-current');
    
    progressBar.style.width = percentage + '%';
    progressBar.textContent = percentage + '%';
    currentLevel.textContent = Math.round(finalBatteryLevel);
    
    // æ ¹æ“šé›»é‡æ”¹è®Šé¡è‰²ï¼ˆè€ƒæ…®å®‰å…¨ç¯„åœï¼‰
    if (percentage < 10) {
        progressBar.className = 'progress-bar bg-danger';
    } else if (percentage < 20) {
        progressBar.className = 'progress-bar bg-warning';
    } else if (percentage > 90) {
        progressBar.className = 'progress-bar bg-info';
    } else {
        progressBar.className = 'progress-bar bg-success';
    }
    
    // æ›´æ–°è“„é›»æ± è¦æ ¼èªªæ˜
    const specDiv = document.querySelector('.alert-info ul');
    if (specDiv) {
        const statusText = percentage < 10 ? 'âš ï¸ é›»é‡éä½' : 
                          percentage > 90 ? 'âš ï¸ é›»é‡éé«˜' : 
                          'âœ… å®‰å…¨ç¯„åœ';
        
        const isWeekendDay = isWeekend(dateStr);
        const dayType = isWeekendDay ? 'å‡æ—¥' : 'å¹³æ—¥';
        
        specDiv.innerHTML = `
            <li>ç¸½å®¹é‡ï¼š1260 kWh</li>
            <li>å®‰å…¨ç¯„åœï¼š126 - 1134 kWh (10% - 90%)</li>
            <li>ç•¶å‰é›»é‡ï¼š${Math.round(finalBatteryLevel)} kWh (${percentage}%) ${statusText}</li>
            <li>æœ€å¤§å……é›»åŠŸç‡ï¼š200 kWh/å°æ™‚</li>
            <li>æœ€å¤§æ”¾é›»åŠŸç‡ï¼š200 kWh/å°æ™‚</li>
            <li>å……é›»æ•ˆç‡ï¼š100%ï¼ˆå……é›»ç„¡æè€—ï¼‰</li>
            <li>æ”¾é›»æ•ˆç‡ï¼š90%ï¼ˆ10%æ”¾é›»æè€—ï¼‰</li>
            <li>è‡ªæ”¾é›»æè€—ï¼š0.03%/å°æ™‚</li>
            <li>å……é›»ä¾†æºï¼šé›¢å³°æ™‚æ®µï¼ˆ1.58å…ƒï¼‰</li>
            <li>å……é›»ç›®æ¨™ï¼š90%é›»é‡</li>
            <li>æ”¾é›»ç­–ç•¥ï¼šå„ªå…ˆå°–å³°æ™‚æ®µ(5.8å…ƒ)ï¼ŒåŠå°–å³°æ™‚æ®µ(3.63å…ƒ)åƒ…ç”¨30%</li>
            <li>æ™ºèƒ½åˆ†é…ï¼šä¿ç•™é›»é‡çµ¦æœ€é«˜é›»åƒ¹æ™‚æ®µ</li>
            <li>æ™‚é–“å€é–“ï¼šå¾é–‹å§‹æ—¥æœŸåˆ°çµæŸæ—¥æœŸï¼Œç¹¼æ‰¿å‰ä¸€å¤©çš„å‰©é¤˜é›»é‡</li>
            <li>çµæŸç­–ç•¥ï¼šæœ€å¾Œä¸€å¤©æ¸…ç©ºè“„é›»æ± ï¼Œä¸ç•™é›»</li>
            <li>åˆ†æç¯„åœï¼š${dateStr}</li>
        `;
    }
}

// æ›´æ–°çœéŒ¢æ–¹æ¡ˆåˆ†æ
function updateBatteryAnalysis(batteryData) {
    // é˜²è­·æª¢æŸ¥ï¼šç¢ºä¿ batteryData å­˜åœ¨ä¸”åŒ…å«å¿…è¦å±¬æ€§
    if (!batteryData || typeof batteryData !== 'object') {
        console.error('batteryData ç‚ºç©ºæˆ–ç„¡æ•ˆ');
        return;
    }
    
    const analysisDiv = document.getElementById('battery-analysis');
    
    // å®‰å…¨åœ°å–å¾—æ•¸çµ„ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡ä½¿ç”¨ç©ºæ•¸çµ„
    const selfDischargeAmounts = batteryData.selfDischargeAmounts || [];
    const chargeAmounts = batteryData.chargeAmounts || [];
    const dischargeAmounts = batteryData.dischargeAmounts || [];
    
    const totalSelfDischarge = selfDischargeAmounts.reduce((sum, val) => sum + (val || 0), 0);
    const totalCharge = chargeAmounts.reduce((sum, val) => sum + (val || 0), 0);
    const totalDischarge = batteryData.totalEffectiveDischarge || dischargeAmounts.reduce((sum, val) => sum + (val || 0), 0);
    const efficiency = totalDischarge > 0 ? ((totalDischarge / (totalCharge - totalSelfDischarge)) * 100).toFixed(1) : 0;
    const utilizationRate = ((totalDischarge + totalSelfDischarge) / (totalCharge + totalSelfDischarge)) * 100;
    
    // å®‰å…¨åœ°å–å¾—æ•¸å€¼ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡ä½¿ç”¨0
    const safeValue = (value) => (value !== undefined && value !== null) ? value : 0;
    
    analysisDiv.innerHTML = `
        <div class="alert alert-success">
            <h6>ç¯€çœæ•ˆæœï¼š</h6>
            <p><strong>åŸå§‹é›»è²»ï¼š</strong> ${safeValue(batteryData.originalCost).toFixed(2)} å…ƒ</p>
            <p><strong>ä½¿ç”¨è“„é›»æ± å¾Œé›»è²»ï¼š</strong> ${safeValue(batteryData.newCost).toFixed(2)} å…ƒ</p>
            <p><strong>ç¯€çœé‡‘é¡ï¼š</strong> <span class="text-success fw-bold">${safeValue(batteryData.netSavings).toFixed(2)} å…ƒ</span></p>
            <p><strong>ç¯€çœæ¯”ä¾‹ï¼š</strong> ${batteryData.originalCost > 0 ? ((safeValue(batteryData.netSavings) / safeValue(batteryData.originalCost)) * 100).toFixed(1) : 0}%</p>
        </div>
        <div class="alert" style="background-color: #e2e3e5; border-color: #d6d8db;">
            <h6 class="text-dark">è“„é›»æ± çµ±è¨ˆï¼š</h6>
            <div class="row">
                <div class="col-3">
                    <p class="text-dark"><strong>ç¸½è³¼é›»é‡ï¼š</strong> ${safeValue(batteryData.totalPurchasePower).toFixed(1)} kWh</p>
                </div>
                <div class="col-3">
                    <p class="text-dark"><strong>è“„é›»æ± é›»è²»ï¼š</strong> ${safeValue(batteryData.batteryElectricityCost).toFixed(2)} å…ƒ</p>
                </div>
                <div class="col-3">
                    <p class="text-dark"><strong>ç¸½æè€—ï¼š</strong> ${safeValue(batteryData.totalLoss).toFixed(1)} kWh</p>
                </div>
                <div class="col-3">
                    <p class="text-dark"><strong>ç¯€ç´„é‡‘é¡ï¼š</strong> ${safeValue(batteryData.totalSavingsAmount).toFixed(2)} å…ƒ</p>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-4">
                <div class="card" style="background-color: #fff3cd; border-color: #ffeaa7;">
                    <div class="card-body text-center">
                        <h6 class="text-dark">å°–å³°æ™‚æ®µç¯€çœ</h6>
                        <h4 class="text-danger">${safeValue(batteryData.peakSavings).toFixed(2)} å…ƒ</h4>
                        <small class="text-dark">5.8å…ƒ/åº¦</small>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card" style="background-color: #d1ecf1; border-color: #bee5eb;">
                    <div class="card-body text-center">
                        <h6 class="text-dark">åŠå°–å³°æ™‚æ®µç¯€çœ</h6>
                        <h4 class="text-primary">${safeValue(batteryData.halfPeakSavings).toFixed(2)} å…ƒ</h4>
                        <small class="text-dark">3.63å…ƒ/åº¦</small>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card" style="background-color: #d4edda; border-color: #c3e6cb;">
                    <div class="card-body text-center">
                        <h6 class="text-dark">é›¢å³°æ™‚æ®µå……é›»</h6>
                        <h4 class="text-success">${totalCharge.toFixed(1)} kWh</h4>
                        <small class="text-dark">1.58å…ƒ/åº¦</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6>ç¸½å……é›»é‡</h6>
                        <h4 class="text-primary">${totalCharge.toFixed(1)} kWh</h4>
                    </div>
                </div>
            </div>
            <div class="col-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6>æœ‰æ•ˆæ”¾é›»é‡</h6>
                        <h4 class="text-success">${totalDischarge.toFixed(1)} kWh</h4>
                        <small class="text-muted">å¯¦éš›å¯ç”¨é›»é‡</small>
                    </div>
                </div>
            </div>
            <div class="col-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6>å¯¦éš›æ”¾é›»é‡</h6>
                        <h4 class="text-info">${(batteryData.totalBatteryDischarge || totalDischarge / 0.9).toFixed(1)} kWh</h4>
                        <small class="text-muted">å¾è“„é›»æ± æ”¾å‡º</small>
                    </div>
                </div>
            </div>
            <div class="col-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6>è‡ªæ”¾é›»æè€—</h6>
                        <h4 class="text-warning">${totalSelfDischarge.toFixed(1)} kWh</h4>
                    </div>
                </div>
            </div>
        </div>
        ${safeValue(batteryData.remainingBatteryLevel) > 0 ? `
        <div class="row mt-2">
            <div class="col-12">
                <div class="alert alert-warning">
                    <strong>æ³¨æ„ï¼š</strong> è“„é›»æ± å‰©é¤˜é›»é‡ ${safeValue(batteryData.remainingBatteryLevel).toFixed(1)} kWh æœªå®Œå…¨æ¸…ç©º
                </div>
            </div>
        </div>
        ` : ''}
        </div>
        <div class="alert mt-3" style="background-color: #d1ecf1; border-color: #bee5eb;">
            <h6 class="text-dark">æ•ˆç‡åˆ†æï¼š</h6>
            <p class="text-dark"><strong>æ•´é«”æ•ˆç‡ï¼š</strong> ${efficiency}% (è€ƒæ…®è‡ªæ”¾é›»æè€—)</p>
            <p class="text-dark"><strong>è“„é›»æ± ä½¿ç”¨ç‡ï¼š</strong> ${utilizationRate.toFixed(1)}% (é¿å…éåº¦æè€—)</p>
            <p class="text-dark"><strong>è‡ªæ”¾é›»æè€—æ¯”ä¾‹ï¼š</strong> ${totalCharge > 0 ? ((totalSelfDischarge / totalCharge) * 100).toFixed(1) : 0}%</p>
            <p class="text-dark"><strong>å……é›»æ•ˆç‡ï¼š</strong> 100% (å……é›»ç„¡æè€—)</p>
            <p class="text-dark"><strong>æ”¾é›»æ•ˆç‡ï¼š</strong> 90% (10%æ”¾é›»æè€—)</p>
            <p class="text-dark"><strong>èƒ½é‡å¹³è¡¡ï¼š</strong> å……é›»é‡ = å¯¦éš›æ”¾é›»é‡ + è‡ªæ”¾é›»æè€— + å‰©é¤˜é›»é‡ ${safeValue(batteryData.remainingBatteryLevel) > 0 ? 'âš ï¸' : 'âœ“'}</p>
            <p class="text-dark"><strong>æ™ºèƒ½ç­–ç•¥ï¼š</strong> å„ªå…ˆä¿ç•™é›»é‡çµ¦å°–å³°æ™‚æ®µ(5.8å…ƒ)ï¼ŒåŠå°–å³°æ™‚æ®µ(3.63å…ƒ)åƒ…ä½¿ç”¨30%é›»é‡</p>
            <p class="text-dark"><strong>å¥‘ç´„å®¹é‡ç­–ç•¥ï¼š</strong> å„ªå…ˆé¿å…è¶…é785 kWh/å°æ™‚é™åˆ¶ï¼Œå¿…è¦æ™‚å¼·åˆ¶æ”¾é›»</p>
            <p class="text-dark"><strong>æ™‚é–“å€é–“ï¼š</strong> å¾é–‹å§‹æ—¥æœŸåˆ°çµæŸæ—¥æœŸï¼Œç¹¼æ‰¿å‰ä¸€å¤©çš„å‰©é¤˜é›»é‡ï¼Œæœ€å¾Œä¸€å¤©æ¸…ç©ºé›»é‡</p>
        </div>
        
        ${batteryData.dailyRates ? `
        <div class="alert mt-3" style="background-color: #fff3cd; border-color: #ffeaa7;">
            <h6 class="text-dark">ç•¶æ—¥é›»åƒ¹æ™‚æ®µåˆ†æï¼š</h6>
            <p class="text-dark"><strong>å°–å³°æ™‚æ®µ (5.8å…ƒ)ï¼š</strong> ${batteryData.dailyRates.peakHours.length > 0 ? batteryData.dailyRates.peakHours.map(h => h + 'æ™‚').join(', ') : 'ç„¡'}</p>
            <p class="text-dark"><strong>åŠå°–å³°æ™‚æ®µ (3.63å…ƒ)ï¼š</strong> ${batteryData.dailyRates.halfPeakHours.length > 0 ? batteryData.dailyRates.halfPeakHours.map(h => h + 'æ™‚').join(', ') : 'ç„¡'}</p>
            <p class="text-dark"><strong>é›¢å³°æ™‚æ®µ (1.58å…ƒ)ï¼š</strong> ${batteryData.dailyRates.offPeakHours.length > 0 ? batteryData.dailyRates.offPeakHours.map(h => h + 'æ™‚').join(', ') : 'ç„¡'}</p>
        </div>
        ` : ''}
        
        <div class="alert mt-3" style="background-color: #f8d7da; border-color: #f5c6cb;">
            <h6 class="text-dark">èƒ½é‡å¹³è¡¡é©—è­‰ï¼š</h6>
            <p class="text-dark"><strong>ç¸½å……é›»é‡ï¼š</strong> ${totalCharge.toFixed(1)} kWh</p>
            <p class="text-dark"><strong>å¯¦éš›æ”¾é›»é‡ï¼š</strong> ${(safeValue(batteryData.totalBatteryDischarge) || totalDischarge / 0.9).toFixed(1)} kWh</p>
            <p class="text-dark"><strong>è‡ªæ”¾é›»æè€—ï¼š</strong> ${totalSelfDischarge.toFixed(1)} kWh</p>
            <p class="text-dark"><strong>å‰©é¤˜é›»é‡ï¼š</strong> ${safeValue(batteryData.remainingBatteryLevel).toFixed(1)} kWh</p>
            <p class="text-dark"><strong>å¹³è¡¡é©—è­‰ï¼š</strong> ${totalCharge.toFixed(1)} = ${(safeValue(batteryData.totalBatteryDischarge) || totalDischarge / 0.9).toFixed(1)} + ${totalSelfDischarge.toFixed(1)} + ${safeValue(batteryData.remainingBatteryLevel).toFixed(1)}</p>
            <p class="text-dark"><strong>å·®ç•°ï¼š</strong> ${(totalCharge - ((safeValue(batteryData.totalBatteryDischarge) || totalDischarge / 0.9) + totalSelfDischarge + safeValue(batteryData.remainingBatteryLevel))).toFixed(1)} kWh</p>
        </div>
    `;
}

// æ›´æ–°è©³ç´°åˆ†æçµæœ
function updateBatteryDetails(hours, batteryData, dateStr) {
    // é˜²è­·æª¢æŸ¥
    if (!batteryData || typeof batteryData !== 'object') {
        console.error('batteryData ç‚ºç©ºæˆ–ç„¡æ•ˆ');
        return;
    }
    
    const detailsDiv = document.getElementById('battery-details');
    let tableRows = '';
    
    // å®‰å…¨åœ°å–å¾—æ•¸çµ„
    const chargeAmounts = batteryData.chargeAmounts || [];
    const dischargeAmounts = batteryData.dischargeAmounts || [];
    const selfDischargeAmounts = batteryData.selfDischargeAmounts || [];
    const gridUsage = batteryData.gridUsage || [];
    const savings = batteryData.savings || [];
    const batteryLevels = batteryData.batteryLevels || [];
    
    for (let i = 0; i < hours.length; i++) {
        const hour = hours[i];
        const rate = getElectricityRate(new Date(dateStr), hour);
        const charge = chargeAmounts[i] || 0;
        const discharge = dischargeAmounts[i] || 0;
        const selfDischarge = selfDischargeAmounts[i] || 0;
        const gridUsageVal = gridUsage[i] || 0;
        const savingsVal = savings[i] || 0;
        const batteryLevel = batteryLevels[i] || 0;
        
        tableRows += `
            <tr>
                <td>${hour}</td>
                <td>${rate.toFixed(2)}</td>
                <td>${charge.toFixed(1)}</td>
                <td>${discharge.toFixed(1)}</td>
                <td>${selfDischarge.toFixed(1)}</td>
                <td>${batteryLevel.toFixed(1)}</td>
                <td>${gridUsageVal.toFixed(1)}</td>
                <td>${savingsVal.toFixed(2)}</td>
            </tr>
        `;
    }
    
    detailsDiv.innerHTML = `
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>å°æ™‚</th>
                        <th>é›»åƒ¹ (å…ƒ/kWh)</th>
                        <th>å……é›»é‡ (kWh)</th>
                        <th>æ”¾é›»é‡ (kWh)</th>
                        <th>è‡ªæ”¾é›»æè€— (kWh)</th>
                        <th>è“„é›»æ± é›»é‡ (kWh)</th>
                        <th>é›»ç¶²ç”¨é›» (kWh)</th>
                        <th>ç¯€çœé‡‘é¡ (å…ƒ)</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        </div>
    `;
}

// åˆ†é åˆ‡æ›äº‹ä»¶
document.getElementById('kpt-tab').addEventListener('shown.bs.tab', loadLatestKpt);

document.getElementById('history-tab').addEventListener('shown.bs.tab', function() {
    loadHistoryDates();
    clearHistoryBillSummary();
});

document.getElementById('battery-tab').addEventListener('shown.bs.tab', function() {
    loadHistoryDates();
    // è¨­å®šè“„é›»æ± æ—¥æœŸé¸æ“‡å™¨
    fetch('/dates')
        .then(res => res.json())
        .then(data => {
            if (data.length > 0) {
                const startPicker = document.getElementById('battery-start-date');
                const endPicker = document.getElementById('battery-end-date');
                startPicker.min = data[0];
                startPicker.max = data[data.length-1];
                startPicker.value = data[0];
                endPicker.min = data[0];
                endPicker.max = data[data.length-1];
                endPicker.value = data[Math.min(6, data.length-1)]; // é è¨­é¸æ“‡7å¤©
            }
        });
    
    // æ¸…é™¤ä¹‹å‰çš„åœ–è¡¨
    if (batteryChart) {
        batteryChart.destroy();
        batteryChart = null;
    }
    
    // é‡ç½®åˆ†æçµæœ
    document.getElementById('battery-analysis').innerHTML = '<p class="text-muted">è«‹é¸æ“‡æ—¥æœŸç¯„åœé€²è¡Œåˆ†æ</p>';
    document.getElementById('battery-details').innerHTML = '<p class="text-muted">è«‹é¸æ“‡æ—¥æœŸç¯„åœæŸ¥çœ‹è©³ç´°åˆ†æ</p>';
    
    // é‡ç½®å°èˆªç‹€æ…‹
    dateRangeData = null;
    currentDayIndex = 0;
    updateDayNavigation();
});

document.getElementById('upload-tab').addEventListener('shown.bs.tab', function() {
    // é‡ç½®ä¸Šå‚³ç‹€æ…‹
    uploadedFile = null;
    predictionResults = null;
    allPredictionResults = null; // é‡ç½®æ‰€æœ‰æ•¸æ“š
    document.getElementById('upload-btn').disabled = true;
    document.getElementById('upload-status').innerHTML = '';
    document.getElementById('upload-results').innerHTML = '<p class="text-muted">è«‹å…ˆä¸Šå‚³æª”æ¡ˆé€²è¡Œé æ¸¬</p>';
    document.getElementById('upload-results-table').style.display = 'none';
    document.getElementById('change-date-btn').disabled = true;
    if (uploadKptChart) {
        uploadKptChart.destroy();
        uploadKptChart = null;
    }
    setupDateSelector(); // è¨­å®šä¸Šå‚³è³‡æ–™çš„æ—¥æœŸé¸æ“‡å™¨
});

// é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥ç”¨é›»é æ¸¬
document.addEventListener('DOMContentLoaded', function() {
    loadLatestKpt();
    loadHistoryDates();
    setupFileUpload();
    setupDateSelector();
});
</script>
</body>
</html>
</html>